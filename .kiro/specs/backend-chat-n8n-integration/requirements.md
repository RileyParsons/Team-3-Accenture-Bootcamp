# Requirements Document

## Introduction

This specification defines the requirements for updating the SaveSmart backend chat handler to persist financial plans generated by the n8n AI agent. When the AI agent creates a savings plan for a user, it should be saved to DynamoDB so users can retrieve and reference their plans later. Additionally, deployment automation needs to be established to ensure code changes can be reliably deployed to AWS Lambda.

## Glossary

- **Chat_Handler**: The AWS Lambda function that processes chat messages and communicates with the n8n AI agent
- **n8n_Agent**: The external AI agent service hosted on n8n.cloud that processes user messages and generates savings advice
- **User_Profile**: The complete user data stored in DynamoDB, including financial information and preferences
- **Deployment_Package**: A zip file containing compiled code and dependencies ready for AWS Lambda deployment
- **Environment_Variable**: Configuration values stored in AWS Lambda that control runtime behavior

## Requirements

### Requirement 1: Save Financial Plans to DynamoDB

**User Story:** As a user, I want my financial plans saved automatically, so that I can access and review them later from my profile.

#### Acceptance Criteria

1. WHEN the n8n_Agent returns a response containing a plan object, THE Chat_Handler SHALL save the plan to the savesmart-plans DynamoDB table
2. THE Chat_Handler SHALL generate a unique planId using the format "plan-{timestamp}"
3. THE Chat_Handler SHALL store the planId, userId, plan object, and createdAt timestamp in DynamoDB
4. THE Chat_Handler SHALL use the PutItemCommand from AWS SDK to save the plan
5. THE Chat_Handler SHALL use the marshall function to convert the plan object to DynamoDB format
6. WHEN the plan save operation fails, THE Chat_Handler SHALL log the error but still return the plan to the frontend
7. THE Chat_Handler SHALL NOT fail the entire request if plan saving fails
8. THE Chat_Handler SHALL reference the PLANS_TABLE_NAME environment variable with default value "savesmart-plans"

### Requirement 2: Remove Sensitive Data from User Profile

**User Story:** As a security engineer, I want sensitive user data removed before sending to external services, so that user privacy is protected.

#### Acceptance Criteria

1. WHEN fetching a User_Profile from DynamoDB, THE Chat_Handler SHALL remove the hashedPassword field before sending to n8n_Agent
2. WHEN fetching a User_Profile from DynamoDB, THE Chat_Handler SHALL remove the resetToken field before sending to n8n_Agent
3. WHEN fetching a User_Profile from DynamoDB, THE Chat_Handler SHALL remove the resetTokenExpiry field before sending to n8n_Agent
4. THE Chat_Handler SHALL send all other User_Profile fields to the n8n_Agent unchanged

### Requirement 3: Maintain API Response Format

**User Story:** As a frontend developer, I want the chat API response format to remain consistent, so that the frontend continues to work without changes.

#### Acceptance Criteria

1. WHEN the Chat_Handler receives a successful response from n8n_Agent, THE Chat_Handler SHALL return a 200 status code
2. THE Chat_Handler SHALL include the reply field in the response body
3. THE Chat_Handler SHALL include the savings field in the response body if present in n8n response
4. THE Chat_Handler SHALL include the plan field in the response body if present in n8n response
5. THE Chat_Handler SHALL include CORS headers with Access-Control-Allow-Origin set to "*"

### Requirement 4: Preserve Error Handling

**User Story:** As a backend developer, I want comprehensive error handling maintained, so that failures are properly communicated to the frontend.

#### Acceptance Criteria

1. WHEN the request body is missing userId or message fields, THE Chat_Handler SHALL return a 400 status code with error code "VALIDATION_ERROR"
2. WHEN the User_Profile is not found in DynamoDB, THE Chat_Handler SHALL return a 404 status code with error code "USER_NOT_FOUND"
3. WHEN the N8N_WEBHOOK_URL environment variable is not configured, THE Chat_Handler SHALL return a 500 status code with error code "INTERNAL_ERROR"
4. WHEN the n8n_Agent returns a non-200 status code, THE Chat_Handler SHALL return a 502 status code with error code "AI_AGENT_ERROR"
5. WHEN the request body contains invalid JSON, THE Chat_Handler SHALL return a 400 status code with error code "VALIDATION_ERROR"
6. WHEN an unexpected error occurs, THE Chat_Handler SHALL return a 500 status code with error code "INTERNAL_ERROR"
7. THE Chat_Handler SHALL log all errors to CloudWatch for debugging

### Requirement 5: Add Timeout Handling for n8n Webhook

**User Story:** As a backend developer, I want timeout protection for the n8n webhook call, so that the Lambda function doesn't hang indefinitely waiting for a response.

#### Acceptance Criteria

1. THE Chat_Handler SHALL implement a 55-second timeout for the n8n webhook fetch request
2. THE Chat_Handler SHALL use AbortController to cancel the request if it exceeds the timeout
3. WHEN the webhook request times out, THE Chat_Handler SHALL return a 502 status code with error code "AI_AGENT_ERROR" and message "AI agent timeout"
4. THE Chat_Handler SHALL clear the timeout after the fetch completes successfully
5. THE Chat_Handler SHALL clear the timeout if the fetch fails with a network error
6. THE timeout duration SHALL be less than the Lambda function timeout to allow proper error handling

### Requirement 6: Create Chat Deployment Script

**User Story:** As a DevOps engineer, I want an automated script to create the chat Lambda deployment package, so that deployments are consistent and repeatable.

#### Acceptance Criteria

1. THE Deployment_Script SHALL compile TypeScript code to JavaScript in the dist directory
2. THE Deployment_Script SHALL navigate to the dist/chat directory
3. THE Deployment_Script SHALL initialize a package.json file with type set to "commonjs"
4. THE Deployment_Script SHALL install required dependencies (@aws-sdk/client-dynamodb, @aws-sdk/util-dynamodb)
5. THE Deployment_Script SHALL create a zip file named chat.zip containing all compiled code and dependencies
6. THE Deployment_Script SHALL place the chat.zip file in the savesmart-backend root directory
7. THE Deployment_Script SHALL display success or error messages to guide the user
8. THE Deployment_Script SHALL work on both Unix-like systems (bash) and Windows (PowerShell)

### Requirement 7: Update Deployment Documentation

**User Story:** As a team member, I want clear documentation on deploying the chat handler, so that I can deploy updates to AWS Lambda without errors.

#### Acceptance Criteria

1. THE Deployment_Documentation SHALL specify the exact steps to build and package the chat handler
2. THE Deployment_Documentation SHALL list all required Environment_Variables for the chat Lambda function
3. THE Deployment_Documentation SHALL include the N8N_WEBHOOK_URL configuration instructions
4. THE Deployment_Documentation SHALL specify the Lambda handler name as "chat.handler"
5. THE Deployment_Documentation SHALL specify the recommended timeout as 60 seconds
6. THE Deployment_Documentation SHALL specify the recommended memory allocation as 256 MB
7. THE Deployment_Documentation SHALL include IAM permissions required (dynamodb:GetItem on savesmart-users, dynamodb:PutItem on savesmart-plans)
8. THE Deployment_Documentation SHALL provide a test event example for validating the deployment

### Requirement 8: Environment Variable Configuration

**User Story:** As a backend developer, I want proper environment variable handling, so that the Lambda function can be configured for different environments.

#### Acceptance Criteria

1. THE Chat_Handler SHALL read the N8N_WEBHOOK_URL from process.env
2. THE Chat_Handler SHALL read the USERS_TABLE_NAME from process.env with default value "savesmart-users"
3. THE Chat_Handler SHALL read the PLANS_TABLE_NAME from process.env with default value "savesmart-plans"
4. THE Chat_Handler SHALL read the AWS_REGION from process.env with default value "ap-southeast-2"
5. THE Chat_Handler SHALL validate that N8N_WEBHOOK_URL is configured before attempting to call the webhook
6. THE Deployment_Documentation SHALL include an .env.example file entry for N8N_WEBHOOK_URL

### Requirement 9: Maintain Code Quality Standards

**User Story:** As a developer, I want the code to follow TypeScript best practices, so that it is maintainable and type-safe.

#### Acceptance Criteria

1. THE Chat_Handler SHALL use proper TypeScript types for all function parameters and return values
2. THE Chat_Handler SHALL use the APIGatewayProxyEvent type for the Lambda event parameter
3. THE Chat_Handler SHALL use the APIGatewayProxyResult type for the Lambda return value
4. THE Chat_Handler SHALL define interfaces for the n8n response structure
5. THE Chat_Handler SHALL include JSDoc comments for complex logic
6. THE Chat_Handler SHALL compile without TypeScript errors
